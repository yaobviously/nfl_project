from sqlalchemy import create_engine
import io
import psycopg2

def create_table(df=None, table_name=None, URI=None):
    """
    Creates a table in the database

    Args:
        df (pd.Dataframe: a dataframe to be used to create the table
        table_name: the name of the table to be created
        URI: credentials for the database. defaults to URI
    """

    engine = create_engine(URI)
    print('connected to the db..')

    df.head(0).to_sql(table_name, engine, if_exists='replace', index=False)


def populate_table(df=None, table_name=None, URI=None):
    """
    Populate the table in the db with data from the dataframe.
    
    The method here is quite fast. It uses the copy_from method from
    the psycopg2 library.
    """

    engine = create_engine(URI)
    print('connected to the database..')
    
    df.head(0).to_sql(table_name, engine, if_exists='replace',index=False) 

    conn = engine.raw_connection()
    cur = conn.cursor()
    print('creating the cursor..')

    output = io.StringIO()
    
    print('writing the csv to file..')
    
    df.to_csv(output, sep='\t', header=False, index=False)
    output.seek(0)
    
    
    contents = output.getvalue()
    
    cur.copy_from(output, table_name, null="") # null values become ''
    
    cur.close()
    conn.commit()
    conn.close()
    

def insert_into_table(df=None, table_name=None, URI=None):
    """
    Insert new data into the table.
    """

    engine = create_engine(URI)

    conn = engine.raw_connection()
    cur = conn.cursor()

    output = io.StringIO()

    df.to_csv(output, sep='\t', header=False, index=False)
    output.seek(0)

    contents = output.getvalue()

    cur.copy_from(output, table_name, null="")

    conn.commit()
    cur.close()
    conn.close()
  

def drop_table(table_name=None, URI=None):
    """
    Drop a table from the database. 
    
    """
  
    psyco_conn = psycopg2.connect(URI)
    cursor = psyco_conn.cursor()
    psyco_conn.autocommit = True

    cursor.execute("""DROP TABLE %s;"""%table_name)
    cursor.close()
    psyco_conn.close()
    
